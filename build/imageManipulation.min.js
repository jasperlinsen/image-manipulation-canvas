"use strict";var ImageManipulation={Canvas:function(a){if(!a)return this;var b=document.createElement("canvas");if(!b.getContext||!b.getContext("2d"))throw"Initialisation failed: support for <canvas> is missing.";if(this.image=a.image||!1,this.width=a.width||0,this.height=a.height||0,this.className=a.className||"",this.input=document.createElement("canvas"),this.output=document.createElement("canvas"),this.inputContext=this.input.getContext("2d"),this.outputContext=this.output.getContext("2d"),this.ready=!1,this.queue=[],this.development=a.development&&a.development instanceof Function?a.development:"throw",this.callback=a.callback&&a.callback instanceof Function?a.callback:function(){},this.source=!1,this.resource=!1,this.autoUpdate=a.autoUpdate||!0,a.image)this.image=document.createElement("img"),this.image.addEventListener("load",this.Init.bind(this)),this.image.addEventListener("error",function(){throw"Initialisation failed: image loading returned error."}),this.image.setAttribute("src",a.image);else{if(!a.copy)throw"No image or copy set, cannot initialise";this.Init(a.copy)}return this},Init:function(a){var b,c;b=new Array,a=a||"*[data-manipulate]",c=document.querySelectorAll(a);for(var d=0;d<c.length;d++){var e,f,e=c.item(d),f=e.getAttribute("data-src")||e.getAttribute("src")||!1,g=e.getAttribute("className")||"";if(f)return b.push(new ImageManipulation.Canvas({image:f,className:g,callback:function(a){e.parentNode.insertBefore(a.DOM(),e),e.parentNode.removeChild(e);for(var b,c={_j:1,get string(){var a=1===this._j?"":"-"+this._j;return this._j++,a},set string(a){this._j=a}};b=e.getAttribute("data-manipulate"+c.string);){b=b.split("(");var d=b[1]?b[1].replace(")","").split(","):[];if(!(a[b[0]]instanceof Function))throw"Static @element manipulation ('"+b+"') is not a function.)";a[b[0]].apply(a,d)}},autoUpdate:!0})),b}}};ImageManipulation.Canvas.prototype={Init:function(a){if(this.ready)return this.Throw("Init was ready. Cannot be called again.");if(a instanceof ImageManipulation.Canvas||(a=!1),this.width=a.width||this.image.width,this.height=a.height||this.image.height,this.input.width=a.width||this.width,this.input.height=a.height||this.height,this.output.width=a.width||this.width,this.output.height=a.height||this.height,this.output.className=a.className||this.className,this.image&&this.inputContext.drawImage(this.image,0,0),this.source=a.source||this.inputContext.getImageData(0,0,this.width,this.height),this.resource=a.resource||this.inputContext.getImageData(0,0,this.width,this.height),this.Support.Self=this,this.ready=!0,!a&&this.queue.length)for(var b=0;b<this.queue.length;b++)if(this.queue[b]&&this[this.queue[b][0]]instanceof Function){var c=this.queue[b][1]?this.queue[b][0]:[];this[this.queue[b][0]].call(this,c),this.queue[b]=!1}a||this.callback(this)},Copy:function(){return new ImageManipulation.Canvas({copy:this})},Draw:function(){return this.resource&&this.outputContext.putImageData(new ImageData(this.resource.data,this.width,this.height),0,0),this},Apply:function(){return this.source=this.resource,this.autoUpdate&&this.Draw(),this},Reset:function(){return this.resource=this.source,this.autoUpdate&&this.Draw(),this},DOM:function(a){if(this.Draw(),a){var b=this.output;return b.className=this.className,a.appendChild(b),!0}return this.output},Throw:function(a){if("throw"===this.development)throw a;return this.development(a),this},Warn:function(a){return console&&console.log&&console.log(a),this},isReady:function(a,b){return this.ready?!0:(a&&this.autoUpdate?(this.Warn(a+" called before ready. Added to Queue."),this.queue.push([a,b])):a&&this.Warn(a+" called before ready. Use callback to ensure readiness or add autoUpdate to allow queueing of manipulations."),!1)},Blur:function(a){if(this.isReady("Blur",arguments)){if(!a||isNaN(a))return this.Throw("Blur @param radius:Int is required.");if(a%2)return this.Throw("Blur @param radius:Int needs to be even.");a>5&&this.Warn("Blur @param radius:Int is large and may cause slowdown.");for(var b=1/((a+1)*(a+1)),c=0;c<this.source.data.length;c+=4){for(var d=[0,0,0,255],e=-a/2;a/2>=e;e++)for(var f=-a/2;a/2>=f;f++)for(var g=c-4*(this.width*e+f),h=0;3>h;h++)this.source.data[g+h]?d[h]+=this.source.data[g+h]*b:d[h]+=255*b;for(var h=0;4>h;h++)this.resource.data[c+h]=d[h]}return this.autoUpdate&&this.Draw(),this}},GrayScale:function(a){return this.isReady("GrayScale",arguments)?this.Desaturate(100,a):void 0},Desaturate:function(a,b){if(this.isReady("Desaturate",arguments)){b=b?[.3,.4,.3]:[1/3,1/3,1/3];for(var c=0;c<this.source.data.length;c+=4){for(var d=0,e=0;3>e;e++)d+=this.source.data[c+e]*b[e];for(var e=0;3>e;e++)this.resource.data[c+e]=Math.round(this.source.data[c+e]+(d-this.source.data[c+e])/100*a)}return this.autoUpdate&&this.Draw(),this}},Channel:function(a){if(this.isReady("Channel",arguments)){if("r"==a&&(a=0),"g"==a&&(a=1),"b"==a&&(a=2),"a"==a&&(a=3),0!=a&&1!=a&&2!=a&&3!=a)return this.Throw("Channel has to be either r, g, b or a");for(var b=0;b<this.source.data.length;b+=4){var c=3==a?this.source.data[b+3]:0;this.resource.data[b]=0==a?this.source.data[b]:c,this.resource.data[b+1]=1==a?this.source.data[b+1]:c,this.resource.data[b+2]=2==a?this.source.data[b+2]:c,this.resource.data[b+3]=255}return this.autoUpdate&&this.Draw(),this}},Support:{Self:!1,getPixelAtAxisFromPixel:function(a,b){var c,b,d,e;switch(e=this.Self||{width:0},b%=360,b%45&&e.Warn("getPixelAtAxisFromPixel @angle:Int[45*n] converted to Axis"),b=45*Math.round(b/45)){case 0:c=1;break;case 45:c=e.width+1;break;case 90:c=e.width;break;case 135:c=e.width-1;break;case 180:c=-1;break;case 225:c=-e.width-1;break;case 270:c=-e.width;break;case 315:c=-e.width+1;break;case 360:c=1;break;default:c=0}return c=a+c,a=Math.floor(a/e.width),d=Math.floor(c/e.width),a-1>d||d>a+1?!1:c}}};